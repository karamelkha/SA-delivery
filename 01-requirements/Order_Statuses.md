# Order Statuses — Delivery

Документ описывает статусы заказа в информационной системе сервиса доставки еды «Delivery».

Статусы отражают полный жизненный цикл заказа с точки зрения бизнес-процесса сервиса доставки — от оформления и оплаты до доставки или завершения обработки заказа.

Статусы используются в Functional Requirements и Use Case и являются частью доменной модели системы.

---

## 1. Статусы заказа

### 1.1 Перечень статусов заказа

- **Ожидает оплаты**
- **Заказ не оплачен**
- **Оплачен**
- **Подтверждён рестораном**
- **Отклонён**
- **Готов к доставке**
- **Ожидает назначения курьера**
- **Курьер не назначен**
- **В пути**
- **Доставлен**
- **Отменён**

---

### 1.2 Описание статусов заказа

- **Ожидает оплаты** — заказ создан после оформления клиентом и ожидает оплату.  
  Для данного статуса действует лимит времени на оплату — 15 минут.

- **Заказ не оплачен** — оплата заказа не была выполнена в установленный лимит времени. Заказ закрыт для оплаты и дальнейшей обработки.

- **Оплачен** — оплата заказа успешно получена и зафиксирована системой. Заказ передан ресторану для обработки.

- **Подтверждён рестораном** — ресторан подтвердил возможность выполнения заказа и приступает к его приготовлению.

- **Отклонён** — ресторан отклонил заказ после получения оплаченного заказа. В рамках жизненного цикла заказа статус является финальным. Для оплаченного заказа инициируется пост-процесс возврата через внешнюю интерфейсную границу.

- **Готов к доставке** — заказ приготовлен рестораном и готов к передаче курьеру.

- **Ожидает назначения курьера** — система выполняет процесс назначения курьера для доставки заказа в рамках подпроцесса _Courier_Assignment_Process_. Курьер на заказ ещё не назначен.

- **Курьер не назначен** — курьер не был назначен в течение установленного времени. Заказ требует дальнейшего решения администратора.

- **В пути** — курьер назначен на заказ, подтвердил получение заказа у ресторана и осуществляет доставку заказа клиенту. Статус охватывает период от получения заказа курьером до завершения доставки.

- **Доставлен** — заказ успешно доставлен клиенту. Статус является финальным для успешно выполненного заказа.

- **Отменён** — заказ отменён по решению администратора в рамках обработки проблемных или невыполнимых заказов. В рамках жизненного цикла заказа статус является финальным. Для оплаченного заказа инициируется пост-процесс возврата через внешнюю интерфейсную границу.

---

### 1.3 Допустимые переходы статусов заказа

- **Ожидает оплаты → Оплачен**
- **Ожидает оплаты → Заказ не оплачен** (по истечении 15 минут)
- **Оплачен → Подтверждён рестораном**
- **Оплачен → Отклонён**
- **Подтверждён рестораном → Готов к доставке**
- **Готов к доставке → Ожидает назначения курьера**
- **Ожидает назначения курьера → В пути** (после назначения курьера и подтверждения получения заказа)
- **Ожидает назначения курьера → Курьер не назначен**
- **В пути → Доставлен**
- **Курьер не назначен → Отменён** (по решению администратора)
- **Отклонён → (переходы статусов заказа отсутствуют; для оплаченного заказа формируется событие `RefundRequired`)**
- **Отменён → (переходы статусов заказа отсутствуют; для оплаченного заказа формируется событие `RefundRequired`)**

---

### 1.4 Финальные статусы заказа

Следующие статусы являются финальными и не предполагают дальнейших переходов в рамках жизненного цикла заказа:

- **Заказ не оплачен**
- **Отклонён**
- **Доставлен**
- **Отменён**

---

### 1.5 Пост-процессные состояния возврата (не являются статусами заказа)

Следующие состояния относятся к внешнему процессу возврата оплаты и не изменяют статус заказа:

- **RefundRequired** — система зафиксировала необходимость возврата и сформировала запрос во внешний процесс.
- **RefundInProgress** — внешний процесс принял запрос и выполняет обработку возврата.
- **RefundCompleted** — внешний процесс подтвердил успешное завершение возврата.
- **RefundFailed** — внешний процесс завершился ошибкой или отказом в обработке возврата.

---

### 1.6 Интерфейсная граница с процессом возвратов (out of scope)

Триггеры передачи в процесс возвратов:

- перевод оплаченного заказа в статус **Отклонён**;
- перевод оплаченного заказа в статус **Отменён**.

Минимальный состав передаваемых данных:

- `order_id`;
- `payment_id`/`provider_payment_id`;
- сумма возврата;
- причина инициирования (`RESTAURANT_REJECTED` / `ADMIN_CANCELLED`);
- `event_timestamp`.

Результат процесса возврата фиксируется как событие в истории заказа и не изменяет финальный статус заказа в рамках текущего жизненного цикла.

---

## 2. События, связанные с заказом (не являются статусами)

- **Доставка не выполнена** — событие, фиксируемое курьером в случае невозможности завершить доставку заказа. Событие сопровождается указанием причины из доступного списка и используется для дальнейшей обработки заказа администратором.
